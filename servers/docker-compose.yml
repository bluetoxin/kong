version: '3'

x-server: &server
  platform: linux/amd64
  restart: always
  build:
    context: ./
  ports:
    - 0:22
  networks:
    - servernetwork
  ulimits:
    nofile:
      soft: 4096
      hard: 64000 # ulimit for MongoDB

services:
  proxy:
    <<: *server
    ports:
      - 0:22
      - 80:8080 # Kong Proxy Port
  db: *server
  mongodb: 
    <<: *server
    platform: linux/arm64 # Mongo doesn't work with Rosetta 2
  elasticsearch: 
    <<: *server
    platform: linux/arm64 # Same as Mongo (doesn't support Rosetta 2)
    ports:
      - 0:22
      - 9200:9200 # ES default port
  graylog:
    <<: *server
    platform: linux/arm64 
    ports:
      - 0:22
      - 9000:9000 # Graylog UI 

networks:
  servernetwork:
